<html>
<body>
Сообщает о полях в реализациях <code>LocalQuickFix</code> и <code>IntentionAction</code>, которые препятствуют корректной работе предварительного просмотра. Кроме того, сообщает об избыточных аннотациях <code>@SafeFieldForPreview</code> для полей, типы которых уже известны как безопасные.
<p>
  Предварительный просмотр намерений - это функция платформы IntelliJ, которая показывает изменения, которые будут внесены в текущий файл после применения быстрого исправления или действия намерения. Для реализации этой функции в быстрых исправлениях, <code>LocalQuickFix.generatePreview()</code> вызывается с пользовательским <code>ProblemDescriptor</code>, указывающим на нефизическую копию текущего файла. В действиях намерения <code>IntentionAction.generatePreview()</code> вызывается с нефизической копией текущего файла и виртуальным редактором.
  Обычно эти методы просто делегируют выполнение <code>LocalQuickFix.applyFix()</code> или <code>IntentionAction.invoke()</code>.
  Однако некоторые быстрые исправления могут прямо или косвенно ссылаться на физические элементы и использовать их для записи. Предварительный просмотр не работает, так как быстрое исправление пытается обновить физический PSI вместо нефизического.
  Чтобы избежать этого, реализация <code>generatePreview()</code> по умолчанию делегирует выполнение только если все поля экземпляра класса быстрого исправления или действия намерения имеют безопасные типы (примитивы, строки и т.д.).
</p>
<p>
  Исправить эту проблему можно несколькими способами:
</p>
<ol>
  <li>
    Если поле фактически не хранит никаких ссылок на PSI или PSI используется только для чтения,
вы можете пометить поле аннотацией <code>@SafeFieldForPreview</code>. Если тип поля никогда не может хранить записываемые ссылки на PSI, вы также можете использовать <code>@SafeTypeForPreview</code>.
  </li>
  <li>
    Вы можете переопределить метод <code>getFileModifierForPreview()</code> и создать копию быстрого исправления, перепривязав её к нефизической копии файла, предоставленной в качестве параметра. Используйте <code>PsiTreeUtil.findSameElementInCopy()</code>, чтобы найти соответствующие элементы PSI в предоставленной нефизической копии.
  </li>
  <li>
    Вместо хранения ссылок на PSI в полях, старайтесь извлекать всю необходимую информацию из <code>ProblemDescriptor.getPsiElement()</code> в быстрых исправлениях или из предоставленного файла/редактора в действиях намерения.
    Вы также можете унаследоваться от абстрактного класса <code>LocalQuickFixAndIntentionActionOnPsiElement</code> и реализовать его методы <code>invoke()</code> и <code>isAvailable()</code>, которые имеют
параметры <code>startElement</code> и <code>endElement</code>. Эти параметры автоматически отображаются на нефизическую копию файла.
  </li>
  <li>
    Вы можете переопределить метод <code>generatePreview()</code> и предоставить полностью пользовательское поведение предварительного просмотра.
    Например, вы можете показать пользовательский HTML-документ вместо фактического предварительного просмотра, если вы выполняете действия помимо модификации текущего файла.
  </li>
</ol>
<p>
  Эта проверка не сообщает о наличии пользовательских реализаций <code>getFileModifierForPreview()</code> или <code>generatePreview()</code>. Однако это не гарантирует, что реализация корректна и предварительный просмотр работает.
  Пожалуйста, проведите тестование. Также обратите внимание, что результаты предварительного просмотра вычисляются в фоновом потоке, поэтому вы не можете запускать операции записи или выполнять вычисления, требующие операций записи во время предварительного просмотра. Наконец, если <code>startInWriteAction()</code> возвращает <code>false</code>, предварительный просмотр не будет генерироваться автоматически. В этом случае требуется пользовательская реализация <code>generatePreview()</code>.
</p>
<p><small>Изменения в версии 2022.1</small></p>
</body>
</html>
